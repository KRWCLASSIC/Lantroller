<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PC Control Panel</title>
<style>
:root { --bg:#0f1220; --panel:#171a2b; --accent:#6c8cff; --accent-2:#22c55e; --text:#e5e7eb; --muted:#9ca3af; --danger:#ef4444; --warning:#f59e0b; --card:#0b0e1a; --border:#2a2f45; }
* { box-sizing: border-box; }
body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: linear-gradient(180deg, #0b0e1a 0%, #0f1220 100%); color: var(--text); }
.container { max-width: 1100px; margin: 0 auto; padding: 24px; }
.header { display:flex; align-items:center; justify-content: space-between; margin-bottom: 16px; }
.brand { display:flex; align-items:center; gap:12px; }
.brand .logo { width:36px; height:36px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #a78bfa); display:grid; place-items:center; font-weight: 800; }
.brand h1 { font-size: 20px; margin:0; letter-spacing: 0.3px; }
.header .status { font-size: 12px; color: var(--muted); display:flex; align-items:center; gap:8px; }
.dot { width:10px; height:10px; border-radius:50%; background:#475569; box-shadow: 0 0 0 2px rgba(0,0,0,0.2) inset; }
.dot.online { background:#22c55e; }
.dot.offline { background:#ef4444; }
.panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
.grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
.card { background: linear-gradient(180deg, var(--card), var(--panel)); border:1px solid var(--border); border-radius:12px; padding:14px; }
.card h3 { margin:0 0 8px 0; font-size:14px; color: var(--muted); font-weight:600; letter-spacing: .4px; }
.buttons { display:flex; flex-wrap:wrap; gap:8px; }
button { appearance:none; border:1px solid var(--border); background: #1c2140; color: var(--text); padding:10px 12px; border-radius:8px; font-size:14px; cursor:pointer; transition: .15s ease; }
button:hover { transform: translateY(-1px); border-color: var(--accent); box-shadow: 0 6px 14px rgba(108,140,255,.2); }
button.primary { background: linear-gradient(135deg, var(--accent), #8b5cf6); border-color: transparent; }
button.success { background: linear-gradient(135deg, var(--accent-2), #16a34a); border-color: transparent; }
button.warning { background: linear-gradient(135deg, var(--warning), #f97316); border-color: transparent; }
button.danger { background: linear-gradient(135deg, var(--danger), #b91c1c); border-color: transparent; }
.row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.input { display:flex; gap:8px; width:100%; }
.input input { flex:1; min-width: 140px; background:#0f132d; color: var(--text); border:1px solid var(--border); border-radius:8px; padding:10px 12px; outline:none; }
.terminal { height: 280px; overflow:auto; background:#0a0d1c; border:1px solid var(--border); border-radius: 10px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre-wrap; }
.terminal.small { height: 180px; }
.badge { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:6px 8px; border-radius:999px; color: var(--muted); }
.kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; background:#11152d; border:1px solid var(--border); padding:2px 6px; border-radius:6px; color: var(--text); }
.footer { margin-top: 18px; display:flex; gap:8px; flex-wrap:wrap; justify-content: space-between; color: var(--muted); font-size: 12px; }
.mt-12 { margin-top:12px; }
.flex-1 { flex:1; }
.link { color: var(--text); text-decoration: underline dotted; cursor: pointer; }
.hidden { display:none; }
.muted { color: var(--muted); }
.mb-14 { margin-bottom:14px; }
.mb-10 { margin-bottom:10px; }
@media (max-width: 640px) {
  .container { padding: 16px; }
  .grid { grid-template-columns: 1fr; }
  .row { gap: 10px; }
  .input { flex-direction: column; }
  .input input { width: 100%; }
  .input button { width: 100%; }
  .buttons { flex-direction: column; }
  .buttons button { width: 100%; }
  .terminal { height: 220px; }
  .terminal.small { height: 140px; }
}
</style>
<script>
// Versions (edit here)
const UI_VERSION = 'v3';
const BACKEND_VERSION = '';

async function run(cmd) {
  const res = await fetch(`/actions?cmd=${encodeURIComponent(cmd)}`);
  const text = await res.text();
  toast(text);
}
async function doAction(url) {
  const res = await fetch(url);
  const text = await res.text();
  toast(text);
}
function toast(msg) {
  const el = document.createElement('div');
  el.textContent = typeof msg === 'string' ? msg : JSON.stringify(msg);
  el.style.position = 'fixed';
  el.style.bottom = '20px';
  el.style.left = '50%';
  el.style.transform = 'translateX(-50%)';
  el.style.background = '#11152d';
  el.style.border = '1px solid #2a2f45';
  el.style.color = '#e5e7eb';
  el.style.padding = '10px 12px';
  el.style.borderRadius = '10px';
  el.style.zIndex = 9999;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2000);
}
async function execLive() {
  const input = document.getElementById('cmd');
  const output = document.getElementById('output');
  const runBtn = document.getElementById('runBtn');
  const stopBtn = document.getElementById('stopBtn');
  const cmd = input.value.trim();
  if (!cmd) { input.focus(); return; }
  output.textContent = '';
  runBtn.disabled = true;
  stopBtn.disabled = false;
  let controller = new AbortController();
  window._execController = controller;
  try {
    const res = await fetch('/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cmd }),
      signal: controller.signal
    });
    if (!res.body) {
      output.textContent = await res.text();
      return;
    }
    const reader = res.body.getReader();
    const decoder = new TextDecoder('utf-8');
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      output.textContent += decoder.decode(value, { stream: true });
      output.scrollTop = output.scrollHeight;
    }
  } catch (e) {
    output.textContent += `\n[Error] ${e}\n`;
  } finally {
    runBtn.disabled = false;
    stopBtn.disabled = true;
  }
}
function stopExec() {
  if (window._execController) {
    window._execController.abort();
  }
}
function quickFill(example) {
  const input = document.getElementById('cmd');
  input.value = example;
  input.focus();
}

async function pollHealth() {
  try {
    const res = await fetch('/health', { cache: 'no-store' });
    const ok = res.ok;
    const dot = document.getElementById('statusDot');
    const label = document.getElementById('statusText');
    if (ok) {
      dot.classList.add('online');
      dot.classList.remove('offline');
      label.textContent = 'Online';
    } else {
      dot.classList.add('offline');
      dot.classList.remove('online');
      label.textContent = 'Offline';
    }
  } catch {
    const dot = document.getElementById('statusDot');
    const label = document.getElementById('statusText');
    dot.classList.add('offline');
    dot.classList.remove('online');
    label.textContent = 'Offline';
  }
}

async function loadLogs() {
  try {
    const res = await fetch('/logs?tail=500', { cache: 'no-store' });
    const text = await res.text();
    const area = document.getElementById('logs');
    area.textContent = text || '<no logs yet>';
    area.scrollTop = area.scrollHeight;
  } catch (e) {
    const area = document.getElementById('logs');
    area.textContent = `Error loading logs: ${e}`;
  }
}

window.addEventListener('load', () => {
  const verEl = document.getElementById('versions');
  if (verEl) verEl.textContent = `UI ${UI_VERSION} · Backend ${BACKEND_VERSION}`;
  pollHealth();
  setInterval(pollHealth, 5000);
  loadLogs();
  setInterval(loadLogs, 5000);
});
</script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">PC</div>
      <div>
        <h1>Lantroller</h1>
      </div>
    </div>
    <div class="status">
      <span id="statusDot" class="dot offline"></span>
      <span id="statusText">Offline</span>
      <span class="muted">|</span>
      <span id="versions" class="muted"></span>
    </div>
  </div>

  <div class="panel mb-14">
    <div class="grid">
      <div class="card">
        <h3>Killers</h3>
        <div class="buttons">
          <button onclick="doAction('/kill/discord')">Kill Discord</button>
          <button onclick="doAction('/kill/roblox')">Kill Roblox</button>
          <button onclick="doAction('/kill/browser?name=all')">Kill All Browsers</button>
        </div>
      </div>
      <div class="card">
        <h3>Power</h3>
        <div class="buttons">
          <button class="danger" onclick="run('shutdown /s /t 0')">Shutdown</button>
          <button class="warning" onclick="run('shutdown /r /t 0')">Restart</button>
          <button onclick="run('rundll32.exe user32.dll,LockWorkStation')">Lock</button>
        </div>
      </div>
      <div class="card">
        <h3>Maintenance</h3>
        <div class="buttons">
           <button onclick="doAction('/refetch-ui')">Refetch UI</button>
          <button onclick="doAction('/update')">Update Backend</button>
          <button onclick="doAction('/restart')">Restart Server</button>
          <button class="danger" onclick="doAction('/stop')">Stop Lantroller</button>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="row mb-10">
      <div class="badge">Live Command Execution</div>
      <div class="badge">Try <span class="kbd" onclick="quickFill('ipconfig')">ipconfig</span>, <span class="kbd" onclick="quickFill('whoami')">whoami</span>, <span class="kbd" onclick="quickFill('ping 8.8.8.8 -n 3')">ping 8.8.8.8 -n 3</span></div>
    </div>
    <div class="input mb-10">
      <input id="cmd" type="text" placeholder="Enter a command to run, e.g. ipconfig" onkeydown="if(event.key==='Enter') execLive()">
      <button id="runBtn" class="success" onclick="execLive()">Run</button>
      <button id="stopBtn" onclick="stopExec()" disabled>Stop</button>
    </div>
    <div class="terminal" id="output"></div>
  </div>

  <div class="panel mt-12">
    <div class="row mb-10">
      <div class="badge">Keyboard & Mouse</div>
      <div class="badge muted">Hold a key; on release, it sends the duration. Joystick moves mouse.</div>
    </div>
    <div class="row mb-10">
      <div id="keyboard" class="flex-1"></div>
      <div style="width:220px; display:flex; flex-direction:column; gap:10px; align-items:center;">
        <div class="badge">Mouse</div>
        <canvas id="joystick" width="200" height="200" style="background:#0a0d1c; border:1px solid var(--border); border-radius:10px;"></canvas>
        <div class="muted" style="font-size:12px">Drag to move</div>
      </div>
    </div>
  </div>

  <script>
  // Keyboard UI with hold timing
  const KEY_ROWS = [
    ['ESC','1','2','3','4','5','6','7','8','9','0','MINUS','EQUAL','BACKSPACE'],
    ['TAB','Q','W','E','R','T','Y','U','I','O','P','LBRACKET','RBRACKET','BACKSLASH'],
    ['CTRL','A','S','D','F','G','H','J','K','L','SEMICOLON','QUOTE','ENTER'],
    ['SHIFT','Z','X','C','V','B','N','M','COMMA','PERIOD','SLASH','SPACE']
  ];
  const keyPressStarts = new Map();
  function renderKeyboard(){
    const el = document.getElementById('keyboard');
    el.innerHTML = '';
    for (const row of KEY_ROWS){
      const rowEl = document.createElement('div');
      rowEl.className = 'row mb-10';
      for (const key of row){
        const btn = document.createElement('button');
        btn.textContent = key.length === 1 ? key : key;
        btn.onpointerdown = () => { keyPressStarts.set(key, performance.now()); btn.classList.add('primary'); };
        btn.onpointerup = () => { handleKeyRelease(key); btn.classList.remove('primary'); };
        btn.onpointerleave = () => { if (keyPressStarts.has(key)) { handleKeyRelease(key); btn.classList.remove('primary'); } };
        rowEl.appendChild(btn);
      }
      el.appendChild(rowEl);
    }
  }
  async function handleKeyRelease(key){
    const start = keyPressStarts.get(key);
    if (start == null) return;
    keyPressStarts.delete(key);
    const durationMs = Math.max(0, Math.round(performance.now() - start));
    try{
      const res = await fetch('/input/key', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ key, durationMs }) });
      const text = await res.text();
      toast(text);
    }catch(e){ toast('Key send error: ' + e); }
  }
  renderKeyboard();

  // Joystick for mouse movement
  (function(){
    const canvas = document.getElementById('joystick');
    const ctx = canvas.getContext('2d');
    const radius = 90; // pad radius
    let active = false;
    let pos = {x: 0, y: 0};
    let lastSent = 0;
    const sendEveryMs = 60; // throttle

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      // base
      ctx.fillStyle = '#0b0e1a';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      // ring
      ctx.strokeStyle = '#2a2f45';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(100,100,radius,0,Math.PI*2);
      ctx.stroke();
      // knob
      ctx.fillStyle = '#1c2140';
      ctx.beginPath();
      ctx.arc(100+pos.x,100+pos.y,22,0,Math.PI*2);
      ctx.fill();
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }
    function onPointer(evt){
      const rect = canvas.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height/2;
      const x = evt.clientX - cx;
      const y = evt.clientY - cy;
      const len = Math.hypot(x,y) || 1;
      const max = radius;
      const nx = clamp(x, -max, max);
      const ny = clamp(y, -max, max);
      pos = {x: nx, y: ny};
      draw();

      const now = performance.now();
      if (now - lastSent >= sendEveryMs){
        lastSent = now;
        const scale = 0.2; // pixels per tick
        const dx = Math.round(nx * scale);
        const dy = Math.round(ny * scale);
        if (dx !== 0 || dy !== 0) {
          fetch('/input/mouse/move', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({dx, dy}) }).catch(()=>{});
        }
      }
    }

    canvas.addEventListener('pointerdown', (e)=>{ active = true; onPointer(e); });
    window.addEventListener('pointermove', (e)=>{ if(active) onPointer(e); });
    window.addEventListener('pointerup', ()=>{ active = false; pos = {x:0,y:0}; draw(); });
    draw();
  })();
  </script>
    <div class="row mb-10">
      <div class="badge">Logs</div>
      <div class="badge muted">Last 500 lines · auto-refresh</div>
      <div class="flex-1"></div>
      <button onclick="loadLogs()">Refresh</button>
    </div>
    <div class="terminal small" id="logs"></div>
  </div>

  <div class="footer">
    <div>Built with Flask</div>
    <div class="muted">Be careful: commands run with server permissions.</div>
  </div>
</div>
</body>
</html>
