<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PC Control Panel</title>
<style>
:root { --bg:#0f1220; --panel:#171a2b; --accent:#6c8cff; --accent-2:#22c55e; --text:#e5e7eb; --muted:#9ca3af; --danger:#ef4444; --warning:#f59e0b; --card:#0b0e1a; --border:#2a2f45; }
* { box-sizing: border-box; }
body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: linear-gradient(180deg, #0b0e1a 0%, #0f1220 100%); color: var(--text); }
.container { max-width: 1100px; margin: 0 auto; padding: 24px; }
.header { display:flex; align-items:center; justify-content: space-between; margin-bottom: 16px; }
.brand { display:flex; align-items:center; gap:12px; }
.brand .logo { width:36px; height:36px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), #a78bfa); display:grid; place-items:center; font-weight: 800; }
.brand h1 { font-size: 20px; margin:0; letter-spacing: 0.3px; }
.header .status { font-size: 12px; color: var(--muted); display:flex; align-items:center; gap:8px; }
.dot { width:10px; height:10px; border-radius:50%; background:#475569; box-shadow: 0 0 0 2px rgba(0,0,0,0.2) inset; }
.dot.online { background:#22c55e; }
.dot.offline { background:#ef4444; }
.panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
.grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); }
.card { background: linear-gradient(180deg, var(--card), var(--panel)); border:1px solid var(--border); border-radius:12px; padding:14px; }
.card h3 { margin:0 0 8px 0; font-size:14px; color: var(--muted); font-weight:600; letter-spacing: .4px; }
.buttons { display:flex; flex-wrap:wrap; gap:8px; }
button { appearance:none; border:1px solid var(--border); background: #1c2140; color: var(--text); padding:10px 12px; border-radius:8px; font-size:14px; cursor:pointer; transition: .15s ease; }
button:hover { transform: translateY(-1px); border-color: var(--accent); box-shadow: 0 6px 14px rgba(108,140,255,.2); }
button.primary { background: linear-gradient(135deg, var(--accent), #8b5cf6); border-color: transparent; }
button.success { background: linear-gradient(135deg, var(--accent-2), #16a34a); border-color: transparent; }
button.warning { background: linear-gradient(135deg, var(--warning), #f97316); border-color: transparent; }
button.danger { background: linear-gradient(135deg, var(--danger), #b91c1c); border-color: transparent; }
.row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
.input { display:flex; gap:8px; width:100%; }
.input input { flex:1; min-width: 140px; background:#0f132d; color: var(--text); border:1px solid var(--border); border-radius:8px; padding:10px 12px; outline:none; }
.terminal { height: 280px; overflow:auto; background:#0a0d1c; border:1px solid var(--border); border-radius: 10px; padding:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; white-space: pre-wrap; }
.terminal.small { height: 180px; }
.badge { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); padding:6px 8px; border-radius:999px; color: var(--muted); }
.kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; background:#11152d; border:1px solid var(--border); padding:2px 6px; border-radius:6px; color: var(--text); }
.footer { margin-top: 18px; display:flex; gap:8px; flex-wrap:wrap; justify-content: space-between; color: var(--muted); font-size: 12px; }
.mt-12 { margin-top:12px; }
.flex-1 { flex:1; }
.link { color: var(--text); text-decoration: underline dotted; cursor: pointer; }
.hidden { display:none; }
.muted { color: var(--muted); }
.mb-14 { margin-bottom:14px; }
.mb-10 { margin-bottom:10px; }
.touchpad-canvas { background:#0a0d1c; border:1px solid var(--border); border-radius:10px; touch-action:none; }
.touchpad-wrap { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
.col-gap-8 { display:flex; flex-direction:column; gap:8px; }
@media (max-width: 640px) {
  .container { padding: 16px; }
  .grid { grid-template-columns: 1fr; }
  .row { gap: 10px; }
  .input { flex-direction: column; }
  .input input { width: 100%; }
  .input button { width: 100%; }
  .buttons { flex-direction: column; }
  .buttons button { width: 100%; }
  .terminal { height: 220px; }
  .terminal.small { height: 140px; }
}
</style>
<script>
// Versions (edit here)
const UI_VERSION = 'v3';
const BACKEND_VERSION = '';

async function run(cmd) {
  const res = await fetch(`/actions?cmd=${encodeURIComponent(cmd)}`);
  const text = await res.text();
  toast(text);
}
async function doAction(url) {
  const res = await fetch(url);
  const text = await res.text();
  toast(text);
}
function toast(msg) {
  const el = document.createElement('div');
  el.textContent = typeof msg === 'string' ? msg : JSON.stringify(msg);
  el.style.position = 'fixed';
  el.style.bottom = '20px';
  el.style.left = '50%';
  el.style.transform = 'translateX(-50%)';
  el.style.background = '#11152d';
  el.style.border = '1px solid #2a2f45';
  el.style.color = '#e5e7eb';
  el.style.padding = '10px 12px';
  el.style.borderRadius = '10px';
  el.style.zIndex = 9999;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 2000);
}
async function execLive() {
  const input = document.getElementById('cmd');
  const output = document.getElementById('output');
  const runBtn = document.getElementById('runBtn');
  const stopBtn = document.getElementById('stopBtn');
  const cmd = input.value.trim();
  if (!cmd) { input.focus(); return; }
  output.textContent = '';
  runBtn.disabled = true;
  stopBtn.disabled = false;
  let controller = new AbortController();
  window._execController = controller;
  try {
    const res = await fetch('/exec', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cmd }),
      signal: controller.signal
    });
    if (!res.body) {
      output.textContent = await res.text();
      return;
    }
    const reader = res.body.getReader();
    const decoder = new TextDecoder('utf-8');
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      output.textContent += decoder.decode(value, { stream: true });
      output.scrollTop = output.scrollHeight;
    }
  } catch (e) {
    output.textContent += `\n[Error] ${e}\n`;
  } finally {
    runBtn.disabled = false;
    stopBtn.disabled = true;
  }
}
function stopExec() {
  if (window._execController) {
    window._execController.abort();
  }
}
function quickFill(example) {
  const input = document.getElementById('cmd');
  input.value = example;
  input.focus();
}

async function pollHealth() {
  try {
    const res = await fetch('/health', { cache: 'no-store' });
    const ok = res.ok;
    const dot = document.getElementById('statusDot');
    const label = document.getElementById('statusText');
    if (ok) {
      dot.classList.add('online');
      dot.classList.remove('offline');
      label.textContent = 'Online';
    } else {
      dot.classList.add('offline');
      dot.classList.remove('online');
      label.textContent = 'Offline';
    }
  } catch {
    const dot = document.getElementById('statusDot');
    const label = document.getElementById('statusText');
    dot.classList.add('offline');
    dot.classList.remove('online');
    label.textContent = 'Offline';
  }
}

async function loadLogs() {
  try {
    const res = await fetch('/logs?tail=500', { cache: 'no-store' });
    const text = await res.text();
    const area = document.getElementById('logs');
    area.textContent = text || '<no logs yet>';
    area.scrollTop = area.scrollHeight;
  } catch (e) {
    const area = document.getElementById('logs');
    area.textContent = `Error loading logs: ${e}`;
  }
}

window.addEventListener('load', () => {
  const verEl = document.getElementById('versions');
  if (verEl) verEl.textContent = `UI ${UI_VERSION} · Backend ${BACKEND_VERSION}`;
  pollHealth();
  setInterval(pollHealth, 5000);
  loadLogs();
  setInterval(loadLogs, 5000);
});
</script>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="logo">PC</div>
      <div>
        <h1>Lantroller</h1>
      </div>
    </div>
    <div class="status">
      <span id="statusDot" class="dot offline"></span>
      <span id="statusText">Offline</span>
      <span class="muted">|</span>
      <span id="versions" class="muted"></span>
    </div>
  </div>

  <div class="panel mb-14">
    <div class="grid">
      <div class="card">
        <h3>Killers</h3>
        <div class="buttons">
          <button onclick="doAction('/kill/discord')">Kill Discord</button>
          <button onclick="doAction('/kill/roblox')">Kill Roblox</button>
          <button onclick="doAction('/kill/browser?name=all')">Kill All Browsers</button>
        </div>
      </div>
      <div class="card">
        <h3>Power</h3>
        <div class="buttons">
          <button class="danger" onclick="run('shutdown /s /t 0')">Shutdown</button>
          <button class="warning" onclick="run('shutdown /r /t 0')">Restart</button>
          <button onclick="run('rundll32.exe user32.dll,LockWorkStation')">Lock</button>
        </div>
      </div>
      <div class="card">
        <h3>Maintenance</h3>
        <div class="buttons">
           <button onclick="doAction('/refetch-ui')">Refetch UI</button>
          <button onclick="doAction('/update')">Update Backend</button>
          <button onclick="doAction('/restart')">Restart Server</button>
          <button class="danger" onclick="doAction('/stop')">Stop Lantroller</button>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="row mb-10">
      <div class="badge">Live Command Execution</div>
      <div class="badge">Try <span class="kbd" onclick="quickFill('ipconfig')">ipconfig</span>, <span class="kbd" onclick="quickFill('whoami')">whoami</span>, <span class="kbd" onclick="quickFill('ping 8.8.8.8 -n 3')">ping 8.8.8.8 -n 3</span></div>
    </div>
    <div class="input mb-10">
      <input id="cmd" type="text" placeholder="Enter a command to run, e.g. ipconfig" onkeydown="if(event.key==='Enter') execLive()">
      <button id="runBtn" class="success" onclick="execLive()">Run</button>
      <button id="stopBtn" onclick="stopExec()" disabled>Stop</button>
    </div>
    <div class="terminal" id="output"></div>
  </div>

  <div class="panel mt-12">
    <div class="row mb-10">
      <div class="badge">Mini Keyboard</div>
      <div class="badge muted">Live key down/up</div>
    </div>
    <div id="mini-kb" class="mb-10"></div>
    <div class="row mb-10">
      <div class="badge">Touchpad</div>
      <div class="badge muted">Drag to move · Buttons below</div>
    </div>
    <div class="touchpad-wrap">
      <canvas id="touchpad" width="320" height="200" class="touchpad-canvas"></canvas>
      <div class="col-gap-8">
        <div class="row">
          <button id="lmb-down">LMB Down</button>
          <button id="lmb-up">LMB Up</button>
        </div>
        <div class="row">
          <button id="rmb-down">RMB Down</button>
          <button id="rmb-up">RMB Up</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Mini keyboard definition
  const MINI_ROWS = [
    ['ESC','1','2','3','4','5','6','7','8','9','0','BACKSPACE'],
    ['TAB','Q','W','E','R','T','Y','U','I','O','P','ENTER'],
    ['CTRL','A','S','D','F','G','H','J','K','L','SPACE'],
    ['SHIFT','Z','X','C','V','B','N','M']
  ];

  function renderMiniKeyboard(){
    const wrap = document.getElementById('mini-kb');
    wrap.innerHTML = '';
    for (const row of MINI_ROWS){
      const rowEl = document.createElement('div');
      rowEl.className = 'row mb-10';
      for (const key of row){
        const btn = document.createElement('button');
        btn.textContent = key.length === 1 ? key : key;
        btn.onpointerdown = () => sendKey(key, 'down');
        btn.onpointerup = () => sendKey(key, 'up');
        btn.onpointerleave = () => sendKey(key, 'up');
        rowEl.appendChild(btn);
      }
      wrap.appendChild(rowEl);
    }
  }

  async function sendKey(key, eventType){
    try {
      await fetch('/input/key', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ key, event: eventType })
      });
    } catch {}
  }

  // Touchpad
  (function(){
    const canvas = document.getElementById('touchpad');
    const ctx = canvas.getContext('2d');
    let last = null;
    const sendEveryMs = 16; // ~60Hz
    let lastSent = 0;

    function drawBase(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#0b0e1a';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.strokeStyle = '#2a2f45';
      ctx.strokeRect(0.5,0.5,canvas.width-1,canvas.height-1);
    }
    drawBase();

    function sendDelta(dx, dy){
      fetch('/input/mouse/move', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({dx, dy})}).catch(()=>{});
    }

    function handlePointer(e){
      const now = performance.now();
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      if (last == null) { last = {x, y}; return; }
      const dx = Math.round((x - last.x));
      const dy = Math.round((y - last.y));
      last = {x, y};
      if (now - lastSent >= sendEveryMs){
        lastSent = now;
        if (dx !== 0 || dy !== 0) sendDelta(dx, dy);
      }
    }

    canvas.addEventListener('pointerdown', (e)=>{ canvas.setPointerCapture(e.pointerId); last = null; });
    canvas.addEventListener('pointermove', (e)=>{ if (e.pressure > 0 || e.buttons) handlePointer(e); });
    canvas.addEventListener('pointerup', ()=>{ last = null; });
  })();

  function mouseButton(button, eventType){
    fetch('/input/mouse/button', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({button, event: eventType})}).catch(()=>{});
  }
  document.getElementById('lmb-down').onclick = ()=> mouseButton('left','down');
  document.getElementById('lmb-up').onclick   = ()=> mouseButton('left','up');
  document.getElementById('rmb-down').onclick = ()=> mouseButton('right','down');
  document.getElementById('rmb-up').onclick   = ()=> mouseButton('right','up');

  renderMiniKeyboard();
  </script>
    <div class="row mb-10">
      <div class="badge">Logs</div>
      <div class="badge muted">Last 500 lines · auto-refresh</div>
      <div class="flex-1"></div>
      <button onclick="loadLogs()">Refresh</button>
    </div>
    <div class="terminal small" id="logs"></div>
  </div>

  <div class="footer">
    <div>Built with Flask</div>
    <div class="muted">Be careful: commands run with server permissions.</div>
  </div>
</div>
</body>
</html>
